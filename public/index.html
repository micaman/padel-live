<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Padel Matches</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #111217;
      --card-bg: #f5f5f5;
      --card-border: #d4d4d4;
      --team-text: #111217;
      --point-top-bg: #f7c948;
      --point-bottom-bg: #cfcfcf;
      --point-text: #111217;
      --divider: #d9d9d9;
      --server-dot: #57d657;
    }

    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top left, #303144, #111217 60%);
      font-family: system-ui, -apple-system, sans-serif;
      color: #f5f5f5;
      min-height: 100vh;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status {
      font-size: 13px;
      margin-bottom: 8px;
      opacity: .9;
    }

    .error {
      color: #ff6b6b;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .matches-list {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .match-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .match-group:first-child {
      border-top: none;
      padding-top: 0;
    }

    .match-group-header {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: space-between;
      align-items: baseline;
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      opacity: .85;
    }

    .match-group-title {
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .match-group-title .match-tag {
      border-color: rgba(247, 201, 72, 0.3);
    }

    .match-group-date {
      font-size: 11px;
    }

    .match-group-items {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .match-card {
      display: block;
      text-decoration: none;
      color: inherit;
      background: #181a25;
      border-radius: 8px;
      border: 1px solid #26293a;
      padding: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }

    .match-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.65);
      border-color: #f7c948;
    }

    .match-meta {
      margin-top: 6px;
      font-size: 11px;
      opacity: .85;
      display: flex;
      gap: 10px;
      font-variant-numeric: tabular-nums;
    }

    .match-tags {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .match-tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid rgba(247, 201, 72, 0.45);
      color: #f7c948;
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .match-tag--logo,
    .match-tag--text {
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 8px;
    }

    .match-tag--logo img {
      width: 30px;
      height: 30px;
      object-fit: scale-down;
      background: #aaa;
    }

    .match-tag--logo {
      overflow: hidden;
      background: #aaa;
    }

    .match-tag--text {
      background: rgba(247, 201, 72, 0.15);
      text-align: center;
      line-height: 1.2;
      overflow-wrap: anywhere;
      font-size: xx-small;
    }

    .match-tag--result {
      font-weight: 700;
    }

    .match-tag--win {
      border-color: rgba(87, 214, 87, 0.6);
      color: #57d657;
    }

    .match-tag--loss {
      border-color: rgba(255, 107, 107, 0.6);
      color: #ff6b6b;
    }

    .load-more {
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }

    button {
      padding: 6px 14px;
      border-radius: 4px;
      border: 1px solid #f7c948;
      background: #2b3042;
      color: #fff;
      cursor: pointer;
    }

    button:hover { background: #343a56; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    /* -------- SCOREBOARD -------- */

    .scoreboard-wrapper {
      display: flex;
      justify-content: center;
    }

    .scoreboard {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      display: grid;
      grid-template-columns: 44px 1fr auto 44px;
      overflow: hidden;
    }

    .sb-icon {
      background: linear-gradient(135deg, #242631, #151622);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-icon-symbol {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid #f7c948;
    }

    .sb-teams {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .sb-row {
      padding: 0 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      min-height: 32px;
    }

    .sb-row + .sb-row {
      border-top: 1px solid var(--divider);
    }

    .team-name {
      color: var(--team-text);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .server-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--server-dot);
    }

    .sb-sets {
      background: #000;
      border-left: 1px solid var(--card-border);
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 32px;
      padding-top: 8px;
    }

    .sb-set-col {
      display: grid;
      grid-template-rows: 1fr 1fr;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      color: #aaa;
    }

    .sb-set-top,
    .sb-set-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #444;
    }

    .sb-set-bottom {
      border-bottom: none;
      border-top: 1px solid #444;
    }

    .sb-points {
      display: grid;
      grid-template-rows: 1fr 1fr;
      border-left: 1px solid var(--card-border);
      font-size: 18px;
      font-weight: bold;
    }

    .sb-point-top,
    .sb-point-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
      color: black;
    }

    .sb-point-top {
      background: #aaa;
    }

    .sb-point-bottom {
      background: #aaa;
      border-top: 1px solid var(--card-border);
    }
  </style>
</head>

<body>
  <h1>Padel Matches</h1>

  <div id="status" class="status"></div>
  <div id="error" class="error"></div>

  <div id="matchesList" class="matches-list"></div>

  <div class="load-more">
    <button id="loadMoreBtn">Load 10 more</button>
  </div>

<script>
  const matchesList = document.getElementById('matchesList');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');

  let offset = 0;
  const limit = 10;
  let hasMore = true;
  let loading = false;
  let shownCount = 0;
  let lastGroupKey = null;
  let lastGroupContainer = null;

  function escapeHtml(value) {
    if (typeof value !== 'string') return '';
    return value.replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&':
          return '&amp;';
        case '<':
          return '&lt;';
        case '>':
          return '&gt;';
        case '"':
          return '&quot;';
        case "'":
          return '&#39;';
        default:
          return ch;
      }
    });
  }

  function formatDate(ts) {
    if (!ts) return '??/??/????';
    const d = new Date(ts);
    if (Number.isNaN(d.getTime())) return '??/??/????';
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function formatDateKey(ts) {
    if (!ts) return 'unknown-date';
    const d = new Date(ts);
    if (Number.isNaN(d.getTime())) return 'unknown-date';
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${d.getFullYear()}-${month}-${day}`;
  }

  function normalizeGroupValue(value, fallback) {
    if (typeof value !== 'string') return fallback;
    const trimmed = value.trim().toLowerCase();
    return trimmed || fallback;
  }

  function getGroupKey(match) {
    const typePart = normalizeGroupValue(match.matchType, 'type-unknown');
    const locationPart = normalizeGroupValue(match.matchLocation, 'location-unknown');
    const datePart = formatDateKey(match.lastTimestamp);
    return `${typePart}|${locationPart}|${datePart}`;
  }

  function getGroupMeta(match) {
    return {
      typeLabel: match.matchType || 'Unknown type',
      locationLabel: match.matchLocation || 'Unknown location',
      dateLabel: formatDate(match.lastTimestamp),
    };
  }

  function createGroupSection(match, key) {
    const meta = getGroupMeta(match);
    const section = document.createElement('section');
    section.className = 'match-group';
    section.dataset.groupKey = key;

    const typeIcon = match.matchTypeIconUrl ? buildImageTag(match.matchTypeIconUrl) : '';
    const locationIcon = match.matchLocationLogoUrl ? buildImageTag(match.matchLocationLogoUrl) : '';

    const header = document.createElement('div');
    header.className = 'match-group-header';
    header.innerHTML = `
      <div class="match-group-title">
        ${typeIcon}
        <span>${escapeHtml(meta.typeLabel)} | ${escapeHtml(meta.locationLabel)}</span>
        ${locationIcon}
      </div>
      <div class="match-group-date">${escapeHtml(meta.dateLabel)}</div>
    `;

    const itemsWrap = document.createElement('div');
    itemsWrap.className = 'match-group-items';

    section.appendChild(header);
    section.appendChild(itemsWrap);
    matchesList.appendChild(section);

    return itemsWrap;
  }

  function ensureGroupContainer(match) {
    const key = getGroupKey(match);
    if (key !== lastGroupKey || !lastGroupContainer) {
      lastGroupKey = key;
      lastGroupContainer = createGroupSection(match, key);
    }
    return lastGroupContainer;
  }

  function serverTeam(server) {
    if (typeof server !== 'number') return null;
    if (server >= 1 && server <= 4) return server <= 2 ? 1 : 2;
    if (server === 1 || server === 2) return server;
    return null;
  }

  function parseSets(sets) {
    if (typeof sets !== 'string') return [];
    return sets.split('/').map(s => {
      const m = s.trim().match(/(\d+)\s*-\s*(\d+)/);
      return m ? { t1: m[1], t2: m[2] } : null;
    }).filter(Boolean);
  }

  function shouldHideSetForFinishedMatch(match, top, bottom) {
    if (match.status !== 'finished') return false;
    const normalize = (value) => {
      if (value == null) return null;
      const trimmed = String(value).trim();
      if (!trimmed || trimmed === '-' || trimmed === 'â€”') return null;
      const num = Number(trimmed);
      return Number.isNaN(num) ? trimmed : num;
    };

    const topNorm = normalize(top);
    const bottomNorm = normalize(bottom);

    const bothMissing = topNorm == null && bottomNorm == null;
    const bothZero =
      typeof topNorm === 'number' &&
      typeof bottomNorm === 'number' &&
      topNorm === 0 &&
      bottomNorm === 0;

    return bothMissing || bothZero;
  }

  function renderMetaTags(match) {
    const tags = [];
    const matchIdLabel = `#${match.matchId}`;
    tags.push(buildTextTag(matchIdLabel));
    
    if (match.winnerTeam === 2) {
      tags.push(buildTextTag('W', 'match-tag--result match-tag--win'));
    } else if (match.winnerTeam === 1) {
      tags.push(buildTextTag('L', 'match-tag--result match-tag--loss'));
    }

    return tags.length ? `<div class="match-tags">${tags.join('')}</div>` : '';
  }

  function buildImageTag(imageUrl) {
    const srcAttr = imageUrl ? ` src="${escapeHtml(imageUrl)}"` : '';
    return `<span class="match-tag match-tag--logo"><img${srcAttr} alt=""></span>`;
  }

  function buildTextTag(label, extraClass = '') {
    const safeLabel = escapeHtml(label);
    const classes = ['match-tag', 'match-tag--text'];
    if (extraClass) {
      classes.push(...extraClass.split(' ').filter(Boolean));
    }
    return `<span class="${classes.join(' ')}">${safeLabel}</span>`;
  }

  function createMatchCard(m) {
    const card = document.createElement('a');
    card.className = 'match-card';
    card.href = `/match/${m.matchId}`;

    card.innerHTML = `
      <div class="scoreboard-wrapper">
        <div class="scoreboard">
          <div class="sb-icon"><img src="https://i.imgur.com/GLjjux7.png" width="32px" height="32px"></div>

          <div class="sb-teams">
            <div class="sb-row">
              <div class="team-name">${(m.team1Name || 'Team 1').toUpperCase()}</div>
              <span class="server-dot" style="display:none"></span>
            </div>
            <div class="sb-row">
              <div class="team-name">${(m.team2Name || 'Team 2').toUpperCase()}</div>
              <span class="server-dot" style="display:none"></span>
            </div>
          </div>

          <div class="sb-sets">
            <div class="sb-set-col"><div>-</div><div>-</div></div>
            <div class="sb-set-col"><div>-</div><div>-</div></div>
            <div class="sb-set-col"><div>-</div><div>-</div></div>
          </div>

          <div class="sb-points">
            <div class="sb-point-top">0</div>
            <div class="sb-point-bottom">0</div>
          </div>
        </div>
      </div>

      ${renderMetaTags(m)}
    `;

    const snap = m.lastSnapshot || {};
    const pts = snap.points || {};
    const sets = parseSets(snap.sets);

    const setCols = card.querySelectorAll('.sb-set-col');
    setCols.forEach((col) => {
      col.style.display = '';
      col.children[0].textContent = '-';
      col.children[1].textContent = '-';
    });

    sets.forEach((s, i) => {
      if (!setCols[i] || !s) return;
      setCols[i].children[0].textContent = s.t1;
      setCols[i].children[1].textContent = s.t2;
    });

    setCols.forEach((col, i) => {
      const score = sets[i];
      const top = score?.t1 ?? col.children[0].textContent;
      const bottom = score?.t2 ?? col.children[1].textContent;
      if (shouldHideSetForFinishedMatch(m, top, bottom)) {
        col.style.display = 'none';
      }
    });

    card.querySelector('.sb-point-top').textContent = pts.team1 ?? '0';
    card.querySelector('.sb-point-bottom').textContent = pts.team2 ?? '0';

    const st = serverTeam(snap.server);
    const dots = card.querySelectorAll('.server-dot');
    if (st === 1) dots[0].style.display = 'inline-block';
    if (st === 2) dots[1].style.display = 'inline-block';

    return card;
  }

  async function loadNext() {
    if (loading || !hasMore) return;
    loading = true;
    loadMoreBtn.disabled = true;
    errorEl.textContent = '';

    try {
      const res = await fetch(`/api/db-matches?limit=${limit}&offset=${offset}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      const items = data.items || [];
      const extras = Array.isArray(data.extras) ? data.extras : [];
      const batch = [...items, ...extras];

      batch.forEach((m) => {
        const groupContainer = ensureGroupContainer(m);
        groupContainer.appendChild(createMatchCard(m));
      });

      offset += items.length;
      shownCount += batch.length;
      hasMore = data.hasMore;

      statusEl.textContent = `Showing ${shownCount} matches`;
      loadMoreBtn.style.display = hasMore ? 'inline-block' : 'none';
    } catch (e) {
      console.error(e);
      errorEl.textContent = 'Failed to load matches';
    } finally {
      loading = false;
      loadMoreBtn.disabled = false;
    }
  }

  loadMoreBtn.addEventListener('click', loadNext);

  loadNext();
</script>
</body>
</html>

