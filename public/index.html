<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Padel Matches</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #111217;
      --card-bg: #f5f5f5;
      --card-border: #d4d4d4;
      --team-text: #111217;
      --point-top-bg: #f7c948;
      --point-bottom-bg: #cfcfcf;
      --point-text: #111217;
      --divider: #d9d9d9;
      --server-dot: #57d657;
    }

    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top left, #303144, #111217 60%);
      font-family: system-ui, -apple-system, sans-serif;
      color: #f5f5f5;
      min-height: 100vh;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status {
      font-size: 13px;
      margin-bottom: 10px;
      opacity: .9;
    }

    .error {
      color: #ff6b6b;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .matches-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .match-card {
      display: block;
      text-decoration: none;
      color: inherit;
      background: #181a25;
      border-radius: 8px;
      border: 1px solid #26293a;
      padding: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .match-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.65);
      border-color: #f7c948;
    }

.match-note {
  margin-top: 4px;
  font-size: 12px;
  opacity: 0.85;
  white-space: pre-wrap;
}


    .match-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 11px;
      opacity: 0.85;
    }

    .match-meta span {
      font-variant-numeric: tabular-nums;
    }

    /* SCOREBOARD (same-ish as match view, but scoped for cards) */

    .scoreboard-wrapper {
      display: flex;
      justify-content: center;
    }

    .scoreboard {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      display: grid;
      grid-template-columns: 44px 1fr auto 64px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.45);
    }

    .sb-icon {
      background: linear-gradient(135deg, #242631, #151622);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-icon-symbol {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid #f7c948;
    }

    .sb-teams {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .sb-row {
      padding: 0 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      min-height: 32px;
    }

    .sb-row + .sb-row {
      border-top: 1px solid var(--divider);
    }

    .team-name {
      color: var(--team-text);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
    }

    .team-meta {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .server-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--server-dot);
    }

    .sb-sets {
      background: #000;
      border-left: 1px solid var(--card-border);
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 32px;
    }

    .sb-set-col {
      display: grid;
      grid-template-rows: 1fr 1fr;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      color: #fff;
    }

    .sb-set-top,
    .sb-set-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #444;
    }

    .sb-set-bottom {
      border-bottom: none;
      border-top: 1px solid #444;
    }

    .sb-points {
      display: grid;
      grid-template-rows: 1fr 1fr;
      border-left: 1px solid var(--card-border);
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    .sb-point-top,
    .sb-point-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-point-top {
      background: var(--point-top-bg);
      color: var(--point-text);
    }

    .sb-point-bottom {
      background: var(--point-bottom-bg);
      color: var(--point-text);
      border-top: 1px solid var(--card-border);
    }

    .empty {
      font-size: 13px;
      opacity: .8;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>Padel Matches</h1>
  <div id="status" class="status"></div>
  <div id="error" class="error"></div>

  <div id="matchesList" class="matches-list"></div>

  <script>
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const matchesList = document.getElementById('matchesList');

    function formatDate(ts) {
      if (!ts) return '–';
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return '–';
      return d.toLocaleString();
    }

    // --- helpers mirroring match view ---

    function parseSetsArray(setsString, setsObj) {
      const arr = [];

      if (typeof setsString === 'string' && setsString.trim()) {
        const parts = setsString.split('/').map(s => s.trim()).filter(Boolean);
        for (const part of parts) {
          const m = part.match(/(\d+)\s*-\s*(\d+)/);
          if (m) arr.push({ team1: m[1], team2: m[2] });
        }
        if (arr.length) return arr;
      }

      if (setsObj && (setsObj.team1 !== undefined || setsObj.team2 !== undefined)) {
        arr.push({
          team1: setsObj.team1 ?? '-',
          team2: setsObj.team2 ?? '-'
        });
      }

      return arr;
    }

    function serverTeamFromServerField(server) {
      if (typeof server !== 'number') return null;
      if (server >= 1 && server <= 4) {
        return server <= 2 ? 1 : 2;
      }
      if (server === 1 || server === 2) return server;
      return null;
    }

function createMatchCard(match) {
  const card = document.createElement('a');
  card.href = `/match/${match.matchId}`;
  card.className = 'match-card';

  card.innerHTML = `
    <div class="scoreboard-wrapper">
      <div class="scoreboard">
        <div class="sb-icon"><div class="sb-icon-symbol"></div></div>

        <div class="sb-teams">
          <div class="sb-row">
            <div class="team-name team1Name">TEAM 1</div>
            <div class="team-meta">
              <span class="server-dot team1ServerDot" style="display:none;"></span>
            </div>
          </div>
          <div class="sb-row">
            <div class="team-name team2Name">TEAM 2</div>
            <div class="team-meta">
              <span class="server-dot team2ServerDot" style="display:none;"></span>
            </div>
          </div>
        </div>

        <div class="sb-sets">
          <div class="sb-set-col">
            <div class="sb-set-top set1T1">-</div>
            <div class="sb-set-bottom set1T2">-</div>
          </div>
          <div class="sb-set-col">
            <div class="sb-set-top set2T1">-</div>
            <div class="sb-set-bottom set2T2">-</div>
          </div>
          <div class="sb-set-col">
            <div class="sb-set-top set3T1">-</div>
            <div class="sb-set-bottom set3T2">-</div>
          </div>
        </div>

        <div class="sb-points">
          <div class="sb-point-top team1Points">0</div>
          <div class="sb-point-bottom team2Points">0</div>
        </div>
      </div>
    </div>

    <div class="match-meta">
      <span>${formatDate(match.lastTimestamp)}</span>
      <span>#${match.matchId}</span>
    </div>

    <div class="match-note">
      ${match.note ? match.note.replace(/</g, "&lt;") : '<em>No note</em>'}
    </div>
  `;

  // set team names from DB
  const t1NameEl = card.querySelector('.team1Name');
  const t2NameEl = card.querySelector('.team2Name');
  t1NameEl.textContent = (match.team1Name || 'Team 1').toUpperCase();
  t2NameEl.textContent = (match.team2Name || 'Team 2').toUpperCase();

  // fill scoreboard from lastSnapshot
  populateScoreboardFromSnapshot(card, match.lastSnapshot || {});
  return card;
}


  // set names from DB
  const t1NameEl = card.querySelector('.team1Name');
  const t2NameEl = card.querySelector('.team2Name');
  t1NameEl.textContent = (match.team1Name || 'Team 1').toUpperCase();
  t2NameEl.textContent = (match.team2Name || 'Team 2').toUpperCase();

  populateScoreboardFromSnapshot(card, match.lastSnapshot || {});
  return card;
}


    function populateScoreboardFromSnapshot(card, snap) {
      const team1PointsEl = card.querySelector('.team1Points');
      const team2PointsEl = card.querySelector('.team2Points');
      const team1ServerDot = card.querySelector('.team1ServerDot');
      const team2ServerDot = card.querySelector('.team2ServerDot');

      const setCells = [
        {
          t1: card.querySelector('.set1T1'),
          t2: card.querySelector('.set1T2')
        },
        {
          t1: card.querySelector('.set2T1'),
          t2: card.querySelector('.set2T2')
        },
        {
          t1: card.querySelector('.set3T1'),
          t2: card.querySelector('.set3T2')
        }
      ];

      const setsArr = parseSetsArray(
        typeof snap.sets === 'string' ? snap.sets : '',
        (snap.sets && typeof snap.sets === 'object') ? snap.sets : null
      );

      for (let i = 0; i < setCells.length; i++) {
        const col = setCells[i];
        const s = setsArr[i];
        if (s) {
          col.t1.textContent = s.team1;
          col.t2.textContent = s.team2;
        } else {
          col.t1.textContent = '-';
          col.t2.textContent = '-';
        }
      }

      const pts = snap.points || {};
      team1PointsEl.textContent = pts.team1 ?? '0';
      team2PointsEl.textContent = pts.team2 ?? '0';

      const st = serverTeamFromServerField(snap.server);
      team1ServerDot.style.display = st === 1 ? 'inline-block' : 'none';
      team2ServerDot.style.display = st === 2 ? 'inline-block' : 'none';
    }

    async function loadMatches() {
      statusEl.textContent = 'Loading matches...';
      errorEl.textContent = '';
      matchesList.innerHTML = '';

      try {
        const res = await fetch('/api/db-matches');
        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }
        const matches = await res.json();

        if (!matches.length) {
          statusEl.textContent = '';
          matchesList.innerHTML = '<div class="empty">No matches in database yet.</div>';
          return;
        }

        matchesList.innerHTML = '';
        matches.forEach(m => {
          const card = createMatchCard(m);
          matchesList.appendChild(card);
        });

        statusEl.textContent = `Loaded ${matches.length} matches (latest first).`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = '';
        errorEl.textContent = 'Failed to load matches: ' + err.message;
        matchesList.innerHTML = '<div class="empty">Error loading matches.</div>';
      }
    }

    loadMatches();
  </script>
</body>
</html>


