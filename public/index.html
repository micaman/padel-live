<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Padel Matches</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #111217;
      --card-bg: #f5f5f5;
      --card-border: #d4d4d4;
      --team-text: #111217;
      --point-top-bg: #f7c948;
      --point-bottom-bg: #cfcfcf;
      --point-text: #111217;
      --divider: #d9d9d9;
      --server-dot: #57d657;
    }

    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top left, #303144, #111217 60%);
      font-family: system-ui, -apple-system, sans-serif;
      color: #f5f5f5;
      min-height: 100vh;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status {
      font-size: 13px;
      margin-bottom: 8px;
      opacity: .9;
    }

    .error {
      color: #ff6b6b;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .matches-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .match-card {
      display: block;
      text-decoration: none;
      color: inherit;
      background: #181a25;
      border-radius: 8px;
      border: 1px solid #26293a;
      padding: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }

    .match-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.65);
      border-color: #f7c948;
    }

    .match-meta {
      margin-top: 6px;
      font-size: 11px;
      opacity: .85;
      display: flex;
      gap: 10px;
      font-variant-numeric: tabular-nums;
    }

    .match-tags {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .match-tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(247, 201, 72, 0.45);
      background: rgba(247, 201, 72, 0.15);
      color: #f7c948;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .match-note {
      margin-top: 4px;
      font-size: 12px;
      opacity: .85;
      white-space: pre-wrap;
    }

    .load-more {
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }

    button {
      padding: 6px 14px;
      border-radius: 4px;
      border: 1px solid #f7c948;
      background: #2b3042;
      color: #fff;
      cursor: pointer;
    }

    button:hover { background: #343a56; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    /* -------- SCOREBOARD -------- */

    .scoreboard-wrapper {
      display: flex;
      justify-content: center;
    }

    .scoreboard {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      display: grid;
      grid-template-columns: 44px 1fr auto 64px;
      overflow: hidden;
    }

    .sb-icon {
      background: linear-gradient(135deg, #242631, #151622);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-icon-symbol {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid #f7c948;
    }

    .sb-teams {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .sb-row {
      padding: 0 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      min-height: 32px;
    }

    .sb-row + .sb-row {
      border-top: 1px solid var(--divider);
    }

    .team-name {
      color: var(--team-text);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .server-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--server-dot);
    }

    .sb-sets {
      background: #000;
      border-left: 1px solid var(--card-border);
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 32px;
      padding-top: 9px;
    }

    .sb-set-col {
      display: grid;
      grid-template-rows: 1fr 1fr;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      color: #fff;
    }

    .sb-set-top,
    .sb-set-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #444;
    }

    .sb-set-bottom {
      border-bottom: none;
      border-top: 1px solid #444;
    }

    .sb-points {
      display: grid;
      grid-template-rows: 1fr 1fr;
      border-left: 1px solid var(--card-border);
      font-size: 18px;
      font-weight: bold;
    }

    .sb-point-top,
    .sb-point-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-point-top {
      background: var(--point-top-bg);
    }

    .sb-point-bottom {
      background: var(--point-bottom-bg);
      border-top: 1px solid var(--card-border);
    }
  </style>
</head>

<body>
  <h1>Padel Matches</h1>

  <div id="status" class="status"></div>
  <div id="error" class="error"></div>

  <div id="matchesList" class="matches-list"></div>

  <div class="load-more">
    <button id="loadMoreBtn">Load 10 more</button>
  </div>

<script>
  const matchesList = document.getElementById('matchesList');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');

  let offset = 0;
  const limit = 10;
  let hasMore = true;
  let loading = false;

  function escapeHtml(value) {
    if (typeof value !== 'string') return '';
    return value.replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&':
          return '&amp;';
        case '<':
          return '&lt;';
        case '>':
          return '&gt;';
        case '"':
          return '&quot;';
        case "'":
          return '&#39;';
        default:
          return ch;
      }
    });
  }

  function formatDate(ts) {
    if (!ts) return '???';
    const d = new Date(ts);
    return Number.isNaN(d.getTime()) ? '???' : d.toLocaleString();
  }

  function serverTeam(server) {
    if (typeof server !== 'number') return null;
    if (server >= 1 && server <= 4) return server <= 2 ? 1 : 2;
    if (server === 1 || server === 2) return server;
    return null;
  }

  function parseSets(sets) {
    if (typeof sets !== 'string') return [];
    return sets.split('/').map(s => {
      const m = s.trim().match(/(\d+)\s*-\s*(\d+)/);
      return m ? { t1: m[1], t2: m[2] } : null;
    }).filter(Boolean);
  }

  function renderMetaTags(match) {
    const tags = [];
    if (match.matchType) {
      tags.push(`<span class="match-tag">${escapeHtml(match.matchType)}</span>`);
    }
    if (match.matchLocation) {
      tags.push(`<span class="match-tag">${escapeHtml(match.matchLocation)}</span>`);
    }
    if (!tags.length) return '';
    return `<div class="match-tags">${tags.join('')}</div>`;
  }

  function createMatchCard(m) {
    const card = document.createElement('a');
    card.className = 'match-card';
    card.href = `/match/${m.matchId}`;

    card.innerHTML = `
      <div class="scoreboard-wrapper">
        <div class="scoreboard">
          <div class="sb-icon"><div class="sb-icon-symbol"></div></div>

          <div class="sb-teams">
            <div class="sb-row">
              <div class="team-name">${(m.team1Name || 'Team 1').toUpperCase()}</div>
              <span class="server-dot" style="display:none"></span>
            </div>
            <div class="sb-row">
              <div class="team-name">${(m.team2Name || 'Team 2').toUpperCase()}</div>
              <span class="server-dot" style="display:none"></span>
            </div>
          </div>

          <div class="sb-sets">
            <div class="sb-set-col"><div>-</div><div>-</div></div>
            <div class="sb-set-col"><div>-</div><div>-</div></div>
            <div class="sb-set-col"><div>-</div><div>-</div></div>
          </div>

          <div class="sb-points">
            <div class="sb-point-top">0</div>
            <div class="sb-point-bottom">0</div>
          </div>
        </div>
      </div>

      ${renderMetaTags(m)}

      <div class="match-meta">
        <span>${formatDate(m.lastTimestamp)}</span>
        <span>#${m.matchId}</span>
      </div>

      <div class="match-note">
        ${m.note ? escapeHtml(m.note) : '<em>No note</em>'}
      </div>
    `;

    const snap = m.lastSnapshot || {};
    const pts = snap.points || {};
    const sets = parseSets(snap.sets);

    const setCols = card.querySelectorAll('.sb-set-col');
    sets.forEach((s, i) => {
      if (!setCols[i]) return;
      setCols[i].children[0].textContent = s.t1;
      setCols[i].children[1].textContent = s.t2;
    });

    card.querySelector('.sb-point-top').textContent = pts.team1 ?? '0';
    card.querySelector('.sb-point-bottom').textContent = pts.team2 ?? '0';

    const st = serverTeam(snap.server);
    const dots = card.querySelectorAll('.server-dot');
    if (st === 1) dots[0].style.display = 'inline-block';
    if (st === 2) dots[1].style.display = 'inline-block';

    return card;
  }

  async function loadNext() {
    if (loading || !hasMore) return;
    loading = true;
    loadMoreBtn.disabled = true;
    errorEl.textContent = '';

    try {
      const res = await fetch(`/api/db-matches?limit=${limit}&offset=${offset}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      const items = data.items || [];

      items.forEach(m => matchesList.appendChild(createMatchCard(m)));

      offset += items.length;
      hasMore = data.hasMore;

      statusEl.textContent = `Showing ${offset} matches`;
      loadMoreBtn.style.display = hasMore ? 'inline-block' : 'none';
    } catch (e) {
      console.error(e);
      errorEl.textContent = 'Failed to load matches';
    } finally {
      loading = false;
      loadMoreBtn.disabled = false;
    }
  }

  loadMoreBtn.addEventListener('click', loadNext);

  loadNext();
</script>
</body>
</html>

