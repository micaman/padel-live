<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Padel Payload Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #111217;
      --card-bg: #f5f5f5;
      --card-border: #d4d4d4;
      --team-text: #111217;
      --point-top-bg: #f7c948;
      --point-bottom-bg: #cfcfcf;
      --point-text: #111217;
      --divider: #d9d9d9;
      --server-dot: #57d657;
    }

    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top left, #303144, #111217 60%);
      font-family: system-ui, -apple-system, sans-serif;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .container {
      width: 100%;
      max-width: 900px;
    }

    textarea {
      width: 100%;
      min-height: 160px;
      border-radius: 6px;
      border: 1px solid #303348;
      background: #10121d;
      color: #f5f5f5;
      padding: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      resize: vertical;
    }

    button {
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #f7c948;
      background: #2b3042;
      color: #fff;
      cursor: pointer;
    }

    button:hover {
      background: #343a56;
    }

    .error {
      color: #ff6b6b;
      font-size: 12px;
      margin-top: 4px;
    }

    .status {
      font-size: 13px;
      margin-top: 8px;
      opacity: 0.9;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 12px;
    }

    .slider-row input[type="range"] {
      flex: 1;
    }

    .scoreboard-wrapper {
      margin-top: 12px;
      display: flex;
      justify-content: center;
    }

    .scoreboard {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      display: grid;
      grid-template-columns: 44px 1fr auto 64px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
    }

    .sb-icon {
      background: linear-gradient(135deg, #242631, #151622);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-icon-symbol {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid #f7c948;
    }

    .sb-teams {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .sb-row {
      padding: 0 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      min-height: 32px;
    }

    .sb-row + .sb-row {
      border-top: 1px solid var(--divider);
    }

    .team-name {
      color: var(--team-text);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
    }

    .team-meta {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .server-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--server-dot);
    }

    .sb-sets {
      background: #000;
      border-left: 1px solid var(--card-border);
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 32px;
    }

    .sb-set-col {
      display: grid;
      grid-template-rows: 1fr 1fr;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      color: #fff;
    }

    .sb-set-top,
    .sb-set-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #444;
    }

    .sb-set-bottom {
      border-bottom: none;
      border-top: 1px solid #444;
    }

    .sb-points {
      display: grid;
      grid-template-rows: 1fr 1fr;
      border-left: 1px solid var(--card-border);
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    .sb-point-top,
    .sb-point-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-point-top {
      background: var(--point-top-bg);
      color: var(--point-text);
    }

    .sb-point-bottom {
      background: var(--point-bottom-bg);
      color: var(--point-text);
      border-top: 1px solid var(--card-border);
    }

    .panel {
      background: #181a25;
      border: 1px solid #26293a;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
    }

    .panel h3 {
      margin: 0 0 8px;
      font-size: 13px;
      text-transform: uppercase;
      opacity: .85;
    }

    .names-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .names-grid label {
      font-size: 11px;
      opacity: .7;
    }

    .names-grid input {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #3b3f52;
      background: #111217;
      color: #fff;
    }

    .debug {
      margin-top: 10px;
      padding: 10px;
      background: #111217;
      border-radius: 6px;
      border: 1px solid #25293a;
      font-size: 11px;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .chart-container {
      width: 100%;
      height: 220px;
      max-height: 220px;
      position: relative;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #26293a;
      text-align: left;
    }

    th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      opacity: .9;
    }

    .stat-number {
      text-align: right;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Padel Payload Viewer</h1>

    <div id="status" class="status"></div>
    <div id="error" class="error"></div>

    <!-- (kept, but hidden) manual input panel -->
    <div id="inputPanel" style="display:none;">
      <p style="font-size:13px;opacity:.9;margin:0 0 6px;">
        Paste one JSON payload per line (historical order), then click <b>Load</b>.
      </p>

      <textarea id="payloadInput"></textarea>
      <button id="loadBtn">Load</button>
    </div>

    <!-- MAIN VIEW -->
    <div id="mainView" style="display:none;">

      <!-- SLIDER -->
      <div id="sliderRow" class="slider-row" style="display:none;">
        <span id="timeLabel">Point 1 / 1</span>
        <input type="range" id="timeSlider" min="1" max="1" value="1">
      </div>

      <!-- SCOREBOARD -->
      <div class="scoreboard-wrapper">
        <div class="scoreboard">
          <div class="sb-icon"><div class="sb-icon-symbol"></div></div>

          <div class="sb-teams">
            <div class="sb-row">
              <div class="team-name" id="team1Name">TEAM 1</div>
              <div class="team-meta">
                <span class="server-dot" id="team1ServerDot" style="display:none;"></span>
              </div>
            </div>
            <div class="sb-row">
              <div class="team-name" id="team2Name">TEAM 2</div>
              <div class="team-meta">
                <span class="server-dot" id="team2ServerDot" style="display:none;"></span>
              </div>
            </div>
          </div>

          <div class="sb-sets">
            <div class="sb-set-col">
              <div class="sb-set-top" id="set1T1">-</div>
              <div class="sb-set-bottom" id="set1T2">-</div>
            </div>
            <div class="sb-set-col">
              <div class="sb-set-top" id="set2T1">-</div>
              <div class="sb-set-bottom" id="set2T2">-</div>
            </div>
            <div class="sb-set-col">
              <div class="sb-set-top" id="set3T1">-</div>
              <div class="sb-set-bottom" id="set3T2">-</div>
            </div>
          </div>

          <div class="sb-points">
            <div class="sb-point-top" id="team1Points">0</div>
            <div class="sb-point-bottom" id="team2Points">0</div>
          </div>
        </div>
      </div>

      <!-- NAMES + DEBUG PANEL -->
      <div class="panel" id="namesPanel">
        <h3>Player Names</h3>
        <div class="names-grid">
          <div>
            <label>Team 1 - Player 1</label>
            <input id="t1p1">
          </div>
          <div>
            <label>Team 1 - Player 2</label>
            <input id="t1p2">
          </div>
          <div>
            <label>Team 2 - Player 1</label>
            <input id="t2p1">
          </div>
          <div>
            <label>Team 2 - Player 2</label>
            <input id="t2p2">
          </div>
        </div>
        <button id="applyNamesBtn">Apply Names</button>

        <div class="debug">
          <strong>Match:</strong> <span id="matchLabel"></span><br>
          <strong>Sets string:</strong> <span id="setsStringDebug"></span><br>
          <strong>Snapshot:</strong> <span id="snapshotIndexDebug"></span><br>
          <strong>Payload:</strong>
          <pre id="lastPayloadDebug"></pre>
        </div>
      </div>

      <!-- TEAM STATS -->
      <div class="panel">
        <h3>Team Stats</h3>
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th class="stat-number">Winners</th>
              <th class="stat-number">Errors</th>
              <th class="stat-number">Impact (W−E)</th>
              <th class="stat-number">Breaks/BPs</th>
            </tr>
          </thead>
          <tbody id="statsTableBody"></tbody>
        </table>
      </div>

      <!-- PLAYER STATS -->
      <div class="panel">
        <h3>Player Stats</h3>
        <table>
          <thead>
            <tr>
              <th>Player</th>
              <th class="stat-number">Winners</th>
              <th class="stat-number">Errors</th>
              <th class="stat-number">Impact (W−E)</th>
            </tr>
          </thead>
          <tbody id="playerStatsBody"></tbody>
        </table>
      </div>

      <!-- TIME STATS -->
      <div class="panel">
        <h3>Time Stats</h3>
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th class="stat-number">Value</th>
            </tr>
          </thead>
          <tbody id="timeStatsBody"></tbody>
        </table>
      </div>

      <!-- CHART -->
      <div class="panel">
        <h3>Player Impact (Winners − Errors)</h3>
        <div class="chart-container">
          <canvas id="impactChart"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
let snapshots = [];
let visibleSnapshots = [];
let impactChart = null;
let currentNames = ["P1", "P2", "P3", "P4"];
let currentMatchId = null;

const payloadInput = document.getElementById('payloadInput');
const loadBtn = document.getElementById('loadBtn');
const errorEl = document.getElementById('error');
const statusEl = document.getElementById('status');
const mainView = document.getElementById('mainView');
const inputPanel = document.getElementById('inputPanel');
const namesPanel = document.getElementById('namesPanel');

const sliderRow = document.getElementById('sliderRow');
const timeSlider = document.getElementById('timeSlider');
const timeLabel = document.getElementById('timeLabel');

const team1NameEl = document.getElementById('team1Name');
const team2NameEl = document.getElementById('team2Name');
const team1PointsEl = document.getElementById('team1Points');
const team2PointsEl = document.getElementById('team2Points');
const team1ServerDot = document.getElementById('team1ServerDot');
const team2ServerDot = document.getElementById('team2ServerDot');

const setCells = [
  { t1: document.getElementById('set1T1'), t2: document.getElementById('set1T2') },
  { t1: document.getElementById('set2T1'), t2: document.getElementById('set2T2') },
  { t1: document.getElementById('set3T1'), t2: document.getElementById('set3T2') },
];

const t1p1Input = document.getElementById('t1p1');
const t1p2Input = document.getElementById('t1p2');
const t2p1Input = document.getElementById('t2p1');
const t2p2Input = document.getElementById('t2p2');
const applyNamesBtn = document.getElementById('applyNamesBtn');

const matchLabelEl = document.getElementById('matchLabel');
const setsStringDebugEl = document.getElementById('setsStringDebug');
const lastPayloadDebugEl = document.getElementById('lastPayloadDebug');
const snapshotIndexDebugEl = document.getElementById('snapshotIndexDebug');
const statsTableBody = document.getElementById('statsTableBody');
const playerStatsBody = document.getElementById('playerStatsBody');
const timeStatsBody = document.getElementById('timeStatsBody');

/* --------- AUTO LOAD FROM SERVER BY MATCH ID ---------- */

document.addEventListener('DOMContentLoaded', () => {
  const parts = window.location.pathname.split('/');
  currentMatchId = parts[parts.length - 1] || null;

  if (!currentMatchId) {
    statusEl.textContent = 'No match ID in URL.';
    return;
  }

  statusEl.textContent = `Loading match ${currentMatchId}...`;
  autoLoadFromServer(currentMatchId);
});

async function autoLoadFromServer(matchId) {
  try {
    errorEl.textContent = '';
    const res = await fetch(`/api/match/${matchId}/history`);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json();

    snapshots = data.snapshots || [];
    if (!snapshots.length) {
      statusEl.textContent = 'No snapshots found in DB for this match.';
      return;
    }
    visibleSnapshots = snapshots.slice();

    // apply DB names if available
    const playersFromDb = data.players || [];
    if (playersFromDb.length) {
      const byKey = {};
      playersFromDb.forEach(p => {
        byKey[`${p.team}-${p.slot}`] = p.name;
      });
      currentNames = [
        byKey['1-1'] || currentNames[0],
        byKey['1-2'] || currentNames[1],
        byKey['2-1'] || currentNames[2],
        byKey['2-2'] || currentNames[3],
      ];
    }

    statusEl.textContent = `Loaded ${snapshots.length} payloads for match ${matchId}.`;
    mainView.style.display = 'block';
    inputPanel.style.display = 'none';

    if (snapshots.length > 1) {
      sliderRow.style.display = 'flex';
      timeSlider.min = 1;
      timeSlider.max = snapshots.length;
      timeSlider.value = snapshots.length;
      timeLabel.textContent = `Point ${snapshots.length} / ${snapshots.length}`;
    } else {
      sliderRow.style.display = 'none';
    }

    buildFromVisible();
  } catch (err) {
    console.error(err);
    errorEl.textContent = 'Failed to load match from server: ' + err.message;
  }
}

/* --------- optional manual load ---------- */

loadBtn?.addEventListener('click', () => {
  errorEl.textContent = "";
  statusEl.textContent = "";
  mainView.style.display = 'none';
  snapshots = [];
  visibleSnapshots = [];

  const lines = payloadInput.value.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  if (!lines.length) {
    errorEl.textContent = "No payload lines found.";
    return;
  }

  let matchId = null;
  for (let i = 0; i < lines.length; i++) {
    try {
      const obj = JSON.parse(lines[i]);
      if (!obj || typeof obj !== 'object') continue;
      snapshots.push(obj);
      if (matchId == null) matchId = obj.matchId;
    } catch (e) {
      errorEl.textContent = `Error parsing line ${i + 1}: ${e.message}`;
      return;
    }
  }

  if (!snapshots.length) {
    errorEl.textContent = "No valid JSON objects parsed.";
    return;
  }

  currentMatchId = matchId ? String(matchId) : currentMatchId;

  statusEl.textContent = `Loaded ${snapshots.length} payloads for match ${matchId}.`;
  mainView.style.display = 'block';

  if (snapshots.length > 1) {
    sliderRow.style.display = 'flex';
    timeSlider.min = 1;
    timeSlider.max = snapshots.length;
    timeSlider.value = snapshots.length;
    timeLabel.textContent = `Point ${snapshots.length} / ${snapshots.length}`;
  } else {
    sliderRow.style.display = 'none';
  }

  visibleSnapshots = snapshots.slice();
  buildFromVisible();
});

/* --------- slider & names ---------- */

timeSlider.addEventListener('input', () => {
  const idx = Number(timeSlider.value) - 1;
  const max = snapshots.length;
  const safeIdx = Math.min(Math.max(idx, 0), max - 1);

  visibleSnapshots = snapshots.slice(0, safeIdx + 1);
  timeLabel.textContent = `Point ${safeIdx + 1} / ${max}`;
  buildFromVisible();
});

applyNamesBtn.addEventListener('click', async () => {
  currentNames = [
    t1p1Input.value || "P1",
    t1p2Input.value || "P2",
    t2p1Input.value || "P3",
    t2p2Input.value || "P4",
  ];
  updateNamesOnScoreboard();
  updateTeamStats();
  updatePlayerStatsTable();
  updateTimeStats();
  updateImpactChart();

  if (currentMatchId) {
    try {
      await fetch(`/api/match/${currentMatchId}/players`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          team1: { p1: currentNames[0], p2: currentNames[1] },
          team2: { p1: currentNames[2], p2: currentNames[3] },
        }),
      });
    } catch (e) {
      console.error('Failed to save names:', e);
    }
  }

  if (namesPanel) namesPanel.style.display = 'none';
  if (inputPanel) inputPanel.style.display = 'none';
});

// helpers etc (everything below is exactly as you had it – parsing sets, break stats, chart)

function parseSetsArray(setsString, setsObj) {
  const arr = [];

  if (typeof setsString === 'string' && setsString.trim()) {
    const parts = setsString.split('/').map(s => s.trim()).filter(Boolean);
    for (const part of parts) {
      const m = part.match(/(\d+)\s*-\s*(\d+)/);
      if (m) arr.push({ team1: m[1], team2: m[2] });
    }
    if (arr.length) return arr;
  }

  if (setsObj && (setsObj.team1 !== undefined || setsObj.team2 !== undefined)) {
    arr.push({
      team1: setsObj.team1 ?? '-',
      team2: setsObj.team2 ?? '-'
    });
  }

  return arr;
}

function serverTeamFromServerField(server) {
  if (typeof server !== 'number') return null;
  if (server >= 1 && server <= 4) {
    return server <= 2 ? 1 : 2;
  }
  if (server === 1 || server === 2) return server;
  return null;
}

function updateNamesOnScoreboard() {
  const t1 = `${currentNames[0]}/${currentNames[1]}`.toUpperCase();
  const t2 = `${currentNames[2]}/${currentNames[3]}`.toUpperCase();
  team1NameEl.textContent = t1;
  team2NameEl.textContent = t2;
}

function buildFromVisible() {
  if (!visibleSnapshots.length) return;
  const idx = visibleSnapshots.length - 1;
  const snap = visibleSnapshots[idx];

  const players = snap.players || [];
  currentNames = [
    players[0]?.name || currentNames[0] || "P1",
    players[1]?.name || currentNames[1] || "P2",
    players[2]?.name || currentNames[2] || "P3",
    players[3]?.name || currentNames[3] || "P4",
  ];

  t1p1Input.value = currentNames[0];
  t1p2Input.value = currentNames[1];
  t2p1Input.value = currentNames[2];
  t2p2Input.value = currentNames[3];

  updateNamesOnScoreboard();

  matchLabelEl.textContent = snap.matchId ?? currentMatchId ?? "";
  setsStringDebugEl.textContent =
    typeof snap.sets === 'string'
      ? snap.sets
      : JSON.stringify(snap.sets || {}, null, 2);
  snapshotIndexDebugEl.textContent = `${idx + 1} / ${snapshots.length}`;
  lastPayloadDebugEl.textContent = JSON.stringify(snap, null, 2);

  const setsArr = parseSetsArray(
    typeof snap.sets === 'string' ? snap.sets : "",
    (snap.sets && typeof snap.sets === 'object') ? snap.sets : null
  );
  for (let i = 0; i < setCells.length; i++) {
    const col = setCells[i];
    const s = setsArr[i];
    if (s) {
      col.t1.textContent = s.team1;
      col.t2.textContent = s.team2;
    } else {
      col.t1.textContent = '-';
      col.t2.textContent = '-';
    }
  }

  const pts = snap.points || {};
  team1PointsEl.textContent = pts.team1 ?? "0";
  team2PointsEl.textContent = pts.team2 ?? "0";

  const st = serverTeamFromServerField(snap.server);
  team1ServerDot.style.display = st === 1 ? 'inline-block' : 'none';
  team2ServerDot.style.display = st === 2 ? 'inline-block' : 'none';

  updateTeamStats();
  updatePlayerStatsTable();
  updateTimeStats();
  updateImpactChart();
}

function updateTeamStats() {
  if (!visibleSnapshots.length) return;
  const last = visibleSnapshots[visibleSnapshots.length - 1];
  const players = last.players || [];

  const p1 = players[0] || { winners: 0, errors: 0 };
  const p2 = players[1] || { winners: 0, errors: 0 };
  const p3 = players[2] || { winners: 0, errors: 0 };
  const p4 = players[3] || { winners: 0, errors: 0 };

  const t1W = Number(p1.winners || 0) + Number(p2.winners || 0);
  const t1E = Number(p1.errors || 0) + Number(p2.errors || 0);
  const t2W = Number(p3.winners || 0) + Number(p4.winners || 0);
  const t2E = Number(p3.errors || 0) + Number(p4.errors || 0);

  const bpStats = computeBreakStats();

  const team1Label = `${currentNames[0]}/${currentNames[1]}`;
  const team2Label = `${currentNames[2]}/${currentNames[3]}`;

  statsTableBody.innerHTML = `
    <tr>
      <td>${team1Label}</td>
      <td class="stat-number">${t1W}</td>
      <td class="stat-number">${t1E}</td>
      <td class="stat-number">${t1W - t1E}</td>
      <td class="stat-number">${bpStats.team1.breaks}/${bpStats.team1.bps}</td>
    </tr>
    <tr>
      <td>${team2Label}</td>
      <td class="stat-number">${t2W}</td>
      <td class="stat-number">${t2E}</td>
      <td class="stat-number">${t2W - t2E}</td>
      <td class="stat-number">${bpStats.team2.breaks}/${bpStats.team2.bps}</td>
    </tr>
  `;
}

function updatePlayerStatsTable() {
  if (!visibleSnapshots.length) {
    playerStatsBody.innerHTML = "";
    return;
  }
  const last = visibleSnapshots[visibleSnapshots.length - 1];
  const players = last.players || [];

  const rows = [];
  for (let i = 0; i < 4; i++) {
    const pl = players[i] || { winners: 0, errors: 0 };
    const w = Number(pl.winners || 0);
    const e = Number(pl.errors || 0);
    const name = currentNames[i] || `P${i + 1}`;

    rows.push(`
      <tr>
        <td>${name}</td>
        <td class="stat-number">${w}</td>
        <td class="stat-number">${e}</td>
        <td class="stat-number">${w - e}</td>
      </tr>
    `);
  }

  playerStatsBody.innerHTML = rows.join("\n");
}

function parseTimestamp(snap) {
  if (!snap || snap.timestamp == null) return NaN;
  const n = Number(snap.timestamp);
  return Number.isFinite(n) ? n : NaN;
}

function formatDuration(sec) {
  if (!Number.isFinite(sec) || sec < 0) return "N/A";
  const total = Math.round(sec);
  const h = Math.floor(total / 3600);
  const m = Math.floor((total % 3600) / 60);
  const s = total % 60;
  const pad = (x) => (x < 10 ? "0" + x : String(x));

  if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
  return `${m}:${pad(s)}`;
}

function computeTimeStats() {
  const n = visibleSnapshots.length;
  if (n < 2) return null;

  const times = visibleSnapshots.map(parseTimestamp);
  const validPairs = [];
  for (let i = 1; i < n; i++) {
    const t0 = times[i - 1];
    const t1 = times[i];
    if (Number.isFinite(t0) && Number.isFinite(t1) && t1 >= t0) {
      validPairs.push(t1 - t0);
    }
  }
  if (!validPairs.length) return null;

  const tStart = times.find(Number.isFinite);
  let tEnd = null;
  for (let i = n - 1; i >= 0; i--) {
    if (Number.isFinite(times[i])) {
      tEnd = times[i];
      break;
    }
  }
  if (!Number.isFinite(tStart) || !Number.isFinite(tEnd) || tEnd < tStart) return null;

  const matchDuration = tEnd - tStart;
  let min = validPairs[0];
  let max = validPairs[0];
  let sum = 0;
  for (const d of validPairs) {
    if (d < min) min = d;
    if (d > max) max = d;
    sum += d;
  }
  const avg = sum / validPairs.length;

  return {
    matchDuration,
    shortestPoint: min,
    longestPoint: max,
    averagePoint: avg,
    pointCount: validPairs.length
  };
}

function updateTimeStats() {
  const stats = computeTimeStats();
  if (!stats) {
    timeStatsBody.innerHTML = `
      <tr>
        <td>Game duration</td>
        <td class="stat-number">N/A</td>
      </tr>
      <tr>
        <td>Shortest point</td>
        <td class="stat-number">N/A</td>
      </tr>
      <tr>
        <td>Longest point</td>
        <td class="stat-number">N/A</td>
      </tr>
      <tr>
        <td>Average point</td>
        <td class="stat-number">N/A</td>
      </tr>
    `;
    return;
  }

  timeStatsBody.innerHTML = `
    <tr>
      <td>Game duration</td>
      <td class="stat-number">${formatDuration(stats.matchDuration)}</td>
    </tr>
    <tr>
      <td>Shortest point</td>
      <td class="stat-number">${formatDuration(stats.shortestPoint)}</td>
    </tr>
    <tr>
      <td>Longest point</td>
      <td class="stat-number">${formatDuration(stats.longestPoint)}</td>
    </tr>
    <tr>
      <td>Average point</td>
      <td class="stat-number">${formatDuration(stats.averagePoint)}</td>
    </tr>
  `;
}

function normalizePointStr(s) {
  if (s == null) return "";
  return String(s).trim().toUpperCase();
}

function isBreakPoint(serverPts, recvPts) {
  const s = normalizePointStr(serverPts);
  const r = normalizePointStr(recvPts);

  if (r === "40" && (s === "0" || s === "15" || s === "30")) return true;
  if ((r === "AD" || r === "A") && s === "40") return true;

  return false;
}

function computeBreakStats() {
  const n = visibleSnapshots.length;
  if (!n) return { team1: { bps: 0, breaks: 0 }, team2: { bps: 0, breaks: 0 } };

  const gameInfo = visibleSnapshots.map(snap => {
    const setsString = typeof snap.sets === 'string' ? snap.sets : "";
    const setsObj = (snap.sets && typeof snap.sets === 'object') ? snap.sets : null;
    const arr = parseSetsArray(setsString, setsObj);
    let g1 = 0, g2 = 0;
    for (const s of arr) {
      const a = parseInt(s.team1, 10);
      const b = parseInt(s.team2, 10);
      if (!Number.isNaN(a)) g1 += a;
      if (!Number.isNaN(b)) g2 += b;
    }
    return { g1, g2, total: g1 + g2 };
  });

  const games = {};
  for (let i = 0; i < n; i++) {
    const gi = gameInfo[i];
    const gameIndex = gi.total;

    if (!games[gameIndex]) {
      games[gameIndex] = {
        startIndex: i,
        endIndex: i,
        serverTeam: null,
        hasClassicBP1: false,
        hasClassicBP2: false,
        hasDeuce: false,
        hasAdv: false
      };
    }

    const rec = games[gameIndex];
    if (i > rec.endIndex) rec.endIndex = i;

    const snap = visibleSnapshots[i];
    let sTeam = serverTeamFromServerField(snap.server);
    if (!rec.serverTeam && sTeam) {
      rec.serverTeam = sTeam;
    } else if (!sTeam && rec.serverTeam) {
      sTeam = rec.serverTeam;
    }

    const pts = snap.points || {};
    const p1 = pts.team1;
    const p2 = pts.team2;
    const n1 = normalizePointStr(p1);
    const n2 = normalizePointStr(p2);

    if (n1 === "40" && n2 === "40") {
      rec.hasDeuce = true;
    }
    if (n1 === "AD" || n1 === "A" || n2 === "AD" || n2 === "A") {
      rec.hasAdv = true;
    }

    if (sTeam === 1 || sTeam === 2) {
      const recvTeam = sTeam === 1 ? 2 : 1;
      let classicBP = false;
      if (sTeam === 1) {
        classicBP = isBreakPoint(p1, p2);
      } else {
        classicBP = isBreakPoint(p2, p1);
      }
      if (classicBP) {
        if (recvTeam === 1) rec.hasClassicBP1 = true;
        else rec.hasClassicBP2 = true;
      }
    }
  }

  const bps = { 1: 0, 2: 0 };
  const breaks = { 1: 0, 2: 0 };

  const gameIndices = Object.keys(games).map(Number).sort((a, b) => a - b);
  for (const gameIndex of gameIndices) {
    const rec = games[gameIndex];
    const startIdx = rec.startIndex;
    const endIdx = rec.endIndex;
    const startG1 = gameInfo[startIdx].g1;
    const startG2 = gameInfo[startIdx].g2;

    let gameHasBP1 = rec.hasClassicBP1;
    let gameHasBP2 = rec.hasClassicBP2;

    if (rec.hasDeuce && !rec.hasAdv && (rec.serverTeam === 1 || rec.serverTeam === 2)) {
      const goldenBPTeam = rec.serverTeam === 1 ? 2 : 1;
      if (goldenBPTeam === 1) gameHasBP1 = true;
      else gameHasBP2 = true;
    }

    if (gameHasBP1) bps[1]++;
    if (gameHasBP2) bps[2]++;

    let winner = null;
    for (let j = endIdx + 1; j < n; j++) {
      const gj = gameInfo[j];
      if (gj.total > gameIndex) {
        const d1 = gj.g1 - startG1;
        const d2 = gj.g2 - startG2;
        if (d1 + d2 === 1) {
          if (d1 === 1) winner = 1;
          else if (d2 === 1) winner = 2;
        }
        break;
      }
    }

    if (winner === 1 && gameHasBP1) breaks[1]++;
    if (winner === 2 && gameHasBP2) breaks[2]++;
  }

  return {
    team1: { bps: bps[1], breaks: breaks[1] },
    team2: { bps: bps[2], breaks: breaks[2] }
  };
}

function updateImpactChart() {
  const canvas = document.getElementById('impactChart');
  if (!canvas || !visibleSnapshots.length) {
    if (impactChart) {
      impactChart.destroy();
      impactChart = null;
    }
    return;
  }

  const labels = visibleSnapshots.map((_, i) => i + 1);
  const playerCount = 4;

  const datasets = [];
  for (let i = 0; i < playerCount; i++) {
    const label = (currentNames[i] || `P${i + 1}`).toUpperCase();
    const data = visibleSnapshots.map(snap => {
      const p = snap.players || [];
      const pl = p[i] || { winners: 0, errors: 0 };
      return Number(pl.winners || 0) - Number(pl.errors || 0);
    });

    datasets.push({
      label,
      data,
      borderWidth: 2,
      tension: 0.3,
      fill: false
    });
  }

  const ctx = canvas.getContext('2d');

  if (impactChart) {
    impactChart.data.labels = labels;
    impactChart.data.datasets = datasets;
    impactChart.update();
  } else {
    impactChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            suggestedMin: -5,
            suggestedMax: 5,
            ticks: { color: '#f5f5f5' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          x: {
            ticks: { color: '#f5f5f5' },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#f5f5f5' }
          }
        }
      }
    });
  }
}
</script>

</body>
</html>
