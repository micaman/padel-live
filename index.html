<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Padel Live Scores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #111217;
      --card-bg: #f5f5f5;
      --card-border: #d4d4d4;
      --team-text: #111217;
      --set-bg: #111217;
      --set-text: #ffffff;
      --point-top-bg: #f7c948;
      --point-bottom-bg: #cfcfcf;
      --point-text: #111217;
      --divider: #d9d9d9;
      --server-dot: #57d657;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #303144, #111217 60%);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      margin: 0 0 10px;
      font-weight: 600;
      letter-spacing: 0.06em;
      font-size: 18px;
      text-transform: uppercase;
    }

    .status {
      font-size: 12px;
      min-height: 16px;
    }
    .status.error { color: #ff6b6b; }

    /* LIST VIEW */

    #listView {
      width: 100%;
      max-width: 520px;
    }

    #matchesListEmpty {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 8px;
    }

    .match-card {
      background: #181a25;
      border-radius: 6px;
      border: 1px solid #26293a;
      padding: 10px;
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .match-card a {
      color: #f5f5f5;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .match-card small {
      font-size: 11px;
      opacity: 0.8;
    }

    /* SCOREBOARD VIEW */

    #matchView {
      width: 100%;
      max-width: 520px;
    }

    .scoreboard-wrapper {
      width: 100%;
      max-width: 480px;
      margin: 8px auto 0;
      display: flex;
      justify-content: center;
    }

    .scoreboard {
      display: grid;
      grid-template-columns: 44px 1fr 64px;
      background: var(--card-bg);
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--card-border);
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
      min-height: 70px;
    }

    .sb-icon {
      background: linear-gradient(135deg, #242631, #151622);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }

    .sb-icon-symbol {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid #f7c948;
      position: relative;
    }

    .sb-icon-symbol::before,
    .sb-icon-symbol::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 3px;
      height: 3px;
      border-radius: 999px;
      background: #f7c948;
      box-shadow:
        -7px 0 0 #f7c948,
        7px 0 0 #f7c948,
        0 -7px 0 #f7c948,
        0 7px 0 #f7c948;
    }

    .sb-teams {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .sb-row {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 6px 10px;
    }

    .sb-row + .sb-row { border-top: 1px solid var(--divider); }

    .team-name {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      color: var(--team-text);
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .team-meta {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .set-score-badge {
      min-width: 20px;
      padding: 2px 5px;
      border-radius: 2px;
      background: var(--set-bg);
      color: var(--set-text);
      font-size: 11px;
      text-align: center;
      font-weight: 700;
    }

    .server-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--server-dot);
      box-shadow: 0 0 4px rgba(87,214,87,0.9);
    }

    .sb-points {
      display: grid;
      grid-template-rows: 1fr 1fr;
      font-weight: 700;
      font-size: 18px;
      text-align: center;
      border-left: 1px solid var(--card-border);
      overflow: hidden;
    }

    .sb-point-top,
    .sb-point-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-point-top {
      background: var(--point-top-bg);
      color: var(--point-text);
    }

    .sb-point-bottom {
      background: var(--point-bottom-bg);
      color: var(--point-text);
      border-top: 1px solid var(--card-border);
    }

    /* PANEL */

    .panel {
      width: 100%;
      margin-top: 16px;
      background: #181a25;
      border-radius: 6px;
      padding: 12px;
      border: 1px solid #26293a;
    }

    .panel h3 {
      margin: 0 0 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
    }

    .names-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .names-grid label {
      font-size: 11px;
      opacity: 0.8;
      display: block;
      margin-bottom: 2px;
    }

    .names-grid input {
      width: 100%;
      padding: 5px 6px;
      border-radius: 4px;
      border: 1px solid #3b3f52;
      background: #111217;
      color: #f5f5f5;
      font-size: 13px;
    }

    .panel button {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #f7c948;
      background: #2b3042;
      color: #f5f5f5;
      cursor: pointer;
      font-size: 13px;
    }

    .panel button:hover { background: #343a4f; }

    .debug {
      margin-top: 8px;
      font-size: 11px;
      max-height: 180px;
      overflow: auto;
      background: #111217;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #25293a;
      white-space: pre-wrap;
    }

    @media (max-width: 480px) {
      .scoreboard {
        transform: scale(0.95);
        transform-origin: top center;
      }
    }
  </style>
</head>
<body>
  <h1>Padel Live</h1>

  <!-- LIST VIEW -->
  <div id="listView">
    <p style="font-size:13px;opacity:.85;">Select a match to view its live scoreboard.</p>
    <div id="matchesList"></div>
    <div id="matchesListEmpty" style="display:none;">No matches yet. Start scoring from the watch.</div>
  </div>

  <!-- MATCH VIEW -->
  <div id="matchView" style="display:none;">
    <div id="status" class="status"></div>

    <div class="scoreboard-wrapper">
      <div class="scoreboard">
        <div class="sb-icon">
          <div class="sb-icon-symbol"></div>
        </div>

        <div class="sb-teams">
          <div class="sb-row">
            <div class="team-name" id="team1Name">TEAM 1</div>
            <div class="team-meta">
              <span class="server-dot" id="team1ServerDot" style="display:none;"></span>
              <span class="set-score-badge" id="team1Sets">-</span>
            </div>
          </div>
          <div class="sb-row">
            <div class="team-name" id="team2Name">TEAM 2</div>
            <div class="team-meta">
              <span class="server-dot" id="team2ServerDot" style="display:none;"></span>
              <span class="set-score-badge" id="team2Sets">-</span>
            </div>
          </div>
        </div>

        <div class="sb-points">
          <div class="sb-point-top" id="team1Points">0</div>
          <div class="sb-point-bottom" id="team2Points">0</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Player Names</h3>
      <form id="namesForm">
        <div class="names-grid">
          <div>
            <label for="t1p1">Team 1 - Player 1</label>
            <input id="t1p1" autocomplete="off">
          </div>
          <div>
            <label for="t1p2">Team 1 - Player 2</label>
            <input id="t1p2" autocomplete="off">
          </div>
          <div>
            <label for="t2p1">Team 2 - Player 1</label>
            <input id="t2p1" autocomplete="off">
          </div>
          <div>
            <label for="t2p2">Team 2 - Player 2</label>
            <input id="t2p2" autocomplete="off">
          </div>
        </div>
        <button type="submit">Save Names</button>
      </form>

      <div class="debug">
        <strong>Match:</strong> <span id="matchLabel"></span><br>
        <strong>Score summary:</strong> <span id="scoreSummary"></span><br>
        <strong>Last update:</strong> <span id="updatedAt"></span><br>
        <strong>Games &amp; Player stats:</strong>
        <pre id="stats"></pre>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    let currentMatchId = params.get('matchId') || null;

    const listView = document.getElementById('listView');
    const matchView = document.getElementById('matchView');
    const matchesList = document.getElementById('matchesList');
    const matchesListEmpty = document.getElementById('matchesListEmpty');

    const statusEl = document.getElementById('status');
    const team1NameEl = document.getElementById('team1Name');
    const team2NameEl = document.getElementById('team2Name');
    const team1SetsEl = document.getElementById('team1Sets');
    const team2SetsEl = document.getElementById('team2Sets');
    const team1PointsEl = document.getElementById('team1Points');
    const team2PointsEl = document.getElementById('team2Points');
    const team1ServerDot = document.getElementById('team1ServerDot');
    const team2ServerDot = document.getElementById('team2ServerDot');

    const namesForm = document.getElementById('namesForm');
    const t1p1Input = document.getElementById('t1p1');
    const t1p2Input = document.getElementById('t1p2');
    const t2p1Input = document.getElementById('t2p1');
    const t2p2Input = document.getElementById('t2p2');

    const matchLabelEl = document.getElementById('matchLabel');
    const scoreSummaryEl = document.getElementById('scoreSummary');
    const updatedAtEl = document.getElementById('updatedAt');
    const statsEl = document.getElementById('stats');

    let timer = null;
    let isEditingNames = false;

    function showListView() {
      listView.style.display = 'block';
      matchView.style.display = 'none';
    }

    function showMatchView() {
      listView.style.display = 'none';
      matchView.style.display = 'block';
    }

    function stopPolling() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    }

    function startPolling(matchId) {
      currentMatchId = matchId;
      stopPolling();

      async function poll() {
        if (!isEditingNames) {
          await fetchMatch(matchId);
        }
      }

      poll();
      timer = setInterval(poll, 3000);
    }

    function makeScoreSummary(data) {
      const sets = data.sets || {};
      const games = data.games || {};
      const points = data.points || {};

      const setStr =
        sets.team1 !== undefined && sets.team2 !== undefined
          ? `${sets.team1}-${sets.team2}`
          : '-';
      const gameStr =
        games.team1 !== undefined && games.team2 !== undefined
          ? `${games.team1}-${games.team2}`
          : '-';
      const pointStr =
        points.team1 !== undefined && points.team2 !== undefined
          ? `${points.team1}-${points.team2}`
          : '-';

      return `S ${setStr}  G ${gameStr}  P ${pointStr}`;
    }

    async function fetchMatch(matchId) {
      try {
        const res = await fetch(`/api/match/${encodeURIComponent(matchId)}`);
        if (!res.ok) {
          statusEl.textContent = `Error: ${res.status}`;
          statusEl.className = 'status error';
          return;
        }

        const data = await res.json();
        statusEl.textContent = `Match: ${matchId}`;
        statusEl.className = 'status';
        matchLabelEl.textContent = matchId;

        // names
        const players = data.players || [];
        let team1Name = 'Team 1';
        let team2Name = 'Team 2';
        if (players.length >= 4) {
          team1Name = `${players[0].name || 'P1'}/${players[1].name || 'P2'}`;
          team2Name = `${players[2].name || 'P3'}/${players[3].name || 'P4'}`;
        }
        team1NameEl.textContent = team1Name.toUpperCase();
        team2NameEl.textContent = team2Name.toUpperCase();

        if (!isEditingNames && players.length >= 4 && namesForm.style.display !== 'none') {
          t1p1Input.value = players[0].name || '';
          t1p2Input.value = players[1].name || '';
          t2p1Input.value = players[2].name || '';
          t2p2Input.value = players[3].name || '';
        }

        // sets
        const sets = data.sets || {};
        team1SetsEl.textContent =
          sets.team1 !== undefined ? sets.team1 : '-';
        team2SetsEl.textContent =
          sets.team2 !== undefined ? sets.team2 : '-';

        // points
        const points = data.points || {};
        team1PointsEl.textContent =
          points.team1 !== undefined ? points.team1 : '0';
        team2PointsEl.textContent =
          points.team2 !== undefined ? points.team2 : '0';

        // server
        team1ServerDot.style.display = 'none';
        team2ServerDot.style.display = 'none';
        if (data.server === 1) team1ServerDot.style.display = 'inline-block';
        if (data.server === 2) team2ServerDot.style.display = 'inline-block';

        // debug summary
        const games = data.games || {};
        scoreSummaryEl.textContent = makeScoreSummary(data);

        if (data.updatedAt) {
          const dt = new Date(data.updatedAt);
          updatedAtEl.textContent = dt.toLocaleTimeString();
        } else {
          updatedAtEl.textContent = '';
        }

        const debug = {
          games,
          playerStats: data.playerStats || []
        };
        statsEl.textContent = JSON.stringify(debug, null, 2);
      } catch (err) {
        statusEl.textContent = `Fetch error: ${err.message}`;
        statusEl.className = 'status error';
      }
    }

    async function fetchMatchesList() {
      try {
        const res = await fetch('/api/matches');
        if (!res.ok) return;
        const list = await res.json();

        matchesList.innerHTML = '';
        if (!list.length) {
          matchesListEmpty.style.display = 'block';
          return;
        }
        matchesListEmpty.style.display = 'none';

        list.forEach(m => {
          const card = document.createElement('div');
          card.className = 'match-card';

          const link = document.createElement('a');
          link.href = `?matchId=${encodeURIComponent(m.matchId)}`;
          link.textContent = m.matchId;

          const small = document.createElement('small');
          small.textContent = m.score || 'no score yet';

          card.appendChild(link);
          card.appendChild(small);
          matchesList.appendChild(card);
        });
      } catch (e) {
        // ignore
      }
    }

    // Pause polling while editing names
    namesForm.addEventListener('focusin', () => {
      isEditingNames = true;
    });
    namesForm.addEventListener('focusout', () => {
      setTimeout(() => {
        if (!namesForm.contains(document.activeElement)) {
          isEditingNames = false;
        }
      }, 0);
    });

    namesForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentMatchId) return;

      const body = {
        team1: { p1: t1p1Input.value, p2: t1p2Input.value },
        team2: { p1: t2p1Input.value, p2: t2p2Input.value }
      };

      try {
        await fetch(`/api/match/${encodeURIComponent(currentMatchId)}/players`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        isEditingNames = false;
        // hide form after names set once
        namesForm.style.display = 'none';
        startPolling(currentMatchId);
      } catch (e2) {
        console.error(e2);
      }
    });

    // initial routing
    if (currentMatchId) {
      showMatchView();
      startPolling(currentMatchId);
    } else {
      showListView();
      fetchMatchesList();
      setInterval(fetchMatchesList, 10000);
    }
  </script>
</body>
</html>
