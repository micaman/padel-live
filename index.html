<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Padel Live Scores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #111217;
      --card-bg: #f5f5f5;
      --card-border: #d4d4d4;
      --team-text: #111217;
      --point-top-bg: #f7c948;
      --point-bottom-bg: #cfcfcf;
      --point-text: #111217;
      --divider: #d9d9d9;
      --server-dot: #57d657;
    }

    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top left, #303144, #111217 60%);
      font-family: system-ui, -apple-system, sans-serif;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .status {
      font-size: 12px;
      min-height: 16px;
    }

    /* LIST VIEW */
    #listView {
      width: 100%;
      max-width: 520px;
    }

    .match-card {
      background: #181a25;
      border: 1px solid #26293a;
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .match-card a {
      color: #f5f5f5;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .match-card small {
      opacity: 0.8;
      font-size: 12px;
    }

    #matchesListEmpty {
      opacity: .7;
      margin-top: 8px;
      font-size: 13px;
    }

    /* MATCH VIEW */
    #matchView {
      width: 100%;
      max-width: 520px;
      display: none;
    }

    .scoreboard-wrapper {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    .scoreboard {
      width: 100%;
      max-width: 480px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      display: grid;
      grid-template-columns: 44px 1fr auto 64px; /* icon | teams | sets (auto) | points */
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
    }

    .sb-icon {
      background: linear-gradient(135deg, #242631, #151622);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-icon-symbol {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid #f7c948;
      position: relative;
    }

    .sb-teams {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .sb-row {
      padding: 0 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: stretch;
      min-height: 32px;
    }

    .sb-row + .sb-row {
      border-top: 1px solid var(--divider);
    }

    .team-name {
      color: var(--team-text);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
    }

    .team-meta {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .server-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--server-dot);
    }

    /* SET COLUMNS */
    .sb-sets {
      background: #f0f0f0;
      border-left: 1px solid var(--card-border);
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 32px; /* each set column width */
    }

    .sb-set-col {
      display: grid;
      grid-template-rows: 1fr 1fr;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }

    .sb-set-top,
    .sb-set-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--card-border);
    }

    .sb-set-bottom {
      border-bottom: none;
      border-top: 1px solid var(--card-border);
    }

    /* POINTS COLUMN */
    .sb-points {
      display: grid;
      grid-template-rows: 1fr 1fr;
      border-left: 1px solid var(--card-border);
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    .sb-point-top,
    .sb-point-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-point-top {
      background: var(--point-top-bg);
      color: var(--point-text);
    }

    .sb-point-bottom {
      background: var(--point-bottom-bg);
      color: var(--point-text);
      border-top: 1px solid var(--card-border);
    }

    /* PANELS */
    .panel {
      background: #181a25;
      border: 1px solid #26293a;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
    }

    .panel h3 {
      margin: 0 0 8px;
      font-size: 13px;
      text-transform: uppercase;
      opacity: .85;
    }

    .names-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .names-grid label {
      font-size: 11px;
      opacity: .7;
    }

    .names-grid input {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #3b3f52;
      background: #111217;
      color: #fff;
    }

    .panel button {
      margin-top: 8px;
      padding: 6px 10px;
      border: 1px solid #f7c948;
      background: #2b3042;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }

    /* CHART */
    .chart-container {
      width: 100%;
      height: 200px;
      max-height: 200px;
      position: relative;
      overflow: hidden;
    }

    .debug {
      margin-top: 10px;
      padding: 10px;
      background: #111217;
      border-radius: 6px;
      border: 1px solid #25293a;
      font-size: 11px;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <h1>Padel Live</h1>

  <!-- HOME LIST -->
  <div id="listView">
    <p style="opacity:.85;">Select a match to view.</p>
    <div id="matchesList"></div>
    <div id="matchesListEmpty">No matches yet.</div>
  </div>

  <!-- MATCH PAGE -->
  <div id="matchView">
    <div id="status" class="status"></div>

    <div class="scoreboard-wrapper">
      <div class="scoreboard">
        <div class="sb-icon"><div class="sb-icon-symbol"></div></div>

        <div class="sb-teams">
          <div class="sb-row">
            <div class="team-name" id="team1Name">TEAM 1</div>
            <div class="team-meta">
              <span class="server-dot" id="team1ServerDot" style="display:none;"></span>
            </div>
          </div>
          <div class="sb-row">
            <div class="team-name" id="team2Name">TEAM 2</div>
            <div class="team-meta">
              <span class="server-dot" id="team2ServerDot" style="display:none;"></span>
            </div>
          </div>
        </div>

        <!-- SETS COLUMNS -->
        <div class="sb-sets">
          <div class="sb-set-col">
            <div class="sb-set-top" id="set1T1">-</div>
            <div class="sb-set-bottom" id="set1T2">-</div>
          </div>
          <div class="sb-set-col">
            <div class="sb-set-top" id="set2T1">-</div>
            <div class="sb-set-bottom" id="set2T2">-</div>
          </div>
          <div class="sb-set-col">
            <div class="sb-set-top" id="set3T1">-</div>
            <div class="sb-set-bottom" id="set3T2">-</div>
          </div>
        </div>

        <!-- POINTS COLUMN -->
        <div class="sb-points">
          <div class="sb-point-top" id="team1Points">0</div>
          <div class="sb-point-bottom" id="team2Points">0</div>
        </div>
      </div>
    </div>

    <!-- PLAYER NAME FORM -->
    <div class="panel">
      <h3>Player Names</h3>
      <form id="namesForm">
        <div class="names-grid">
          <div>
            <label>Team 1 - Player 1</label>
            <input id="t1p1">
          </div>
          <div>
            <label>Team 1 - Player 2</label>
            <input id="t1p2">
          </div>
          <div>
            <label>Team 2 - Player 1</label>
            <input id="t2p1">
          </div>
          <div>
            <label>Team 2 - Player 2</label>
            <input id="t2p2">
          </div>
        </div>
        <button type="submit">Save Names</button>
      </form>

      <div class="debug">
        <strong>Match:</strong> <span id="matchLabel"></span><br>
        <strong>Summary:</strong> <span id="scoreSummary"></span><br>
        <strong>Last update:</strong> <span id="updatedAt"></span><br><br>
        <strong>Stats:</strong>
        <pre id="stats"></pre>
      </div>
    </div>

    <!-- CHART -->
    <div class="panel">
      <h3>Player Impact (Winners âˆ’ Errors)</h3>
      <div class="chart-container">
        <canvas id="impactChart"></canvas>
      </div>
    </div>
  </div>

<script>
let impactChart = null;
let isEditingNames = false;
let timer = null;

const params = new URLSearchParams(window.location.search);
let currentMatchId = params.get('matchId') || null;

const listView = document.getElementById('listView');
const matchView = document.getElementById('matchView');
const matchesList = document.getElementById('matchesList');
const matchesListEmpty = document.getElementById('matchesListEmpty');

const statusEl = document.getElementById('status');
const team1NameEl = document.getElementById('team1Name');
const team2NameEl = document.getElementById('team2Name');
const team1PointsEl = document.getElementById('team1Points');
const team2PointsEl = document.getElementById('team2Points');
const team1ServerDot = document.getElementById('team1ServerDot');
const team2ServerDot = document.getElementById('team2ServerDot');

// set column cells
const setCells = [
  {
    t1: document.getElementById('set1T1'),
    t2: document.getElementById('set1T2'),
  },
  {
    t1: document.getElementById('set2T1'),
    t2: document.getElementById('set2T2'),
  },
  {
    t1: document.getElementById('set3T1'),
    t2: document.getElementById('set3T2'),
  },
];

const namesForm = document.getElementById('namesForm');
const t1p1Input = document.getElementById('t1p1');
const t1p2Input = document.getElementById('t1p2');
const t2p1Input = document.getElementById('t2p1');
const t2p2Input = document.getElementById('t2p2');

const matchLabelEl = document.getElementById('matchLabel');
const scoreSummaryEl = document.getElementById('scoreSummary');
const updatedAtEl = document.getElementById('updatedAt');
const statsEl = document.getElementById('stats');

function showList() {
  listView.style.display = 'block';
  matchView.style.display = 'none';
}
function showMatch() {
  listView.style.display = 'none';
  matchView.style.display = 'block';
}

function stopPolling() {
  if (timer) clearInterval(timer);
  timer = null;
}

function startPolling(id) {
  stopPolling();
  async function poll() {
    if (!isEditingNames) fetchMatch(id);
  }
  poll();
  timer = setInterval(poll, 10000); // ðŸ”¥ 10s refresh
}

// parse sets into an array of {team1, team2} for UI columns
function parseSetsArray(data) {
  const arr = [];
  if (typeof data.setsString === 'string' && data.setsString.trim()) {
    const parts = data.setsString.split('/').map(s => s.trim()).filter(Boolean);
    for (const part of parts) {
      const m = part.match(/(\d+)\s*-\s*(\d+)/);
      if (m) {
        arr.push({ team1: m[1], team2: m[2] });
      }
    }
    if (arr.length) return arr;
  }
  const setsObj = data.sets || {};
  if (setsObj.team1 !== undefined || setsObj.team2 !== undefined) {
    arr.push({
      team1: setsObj.team1 ?? '-',
      team2: setsObj.team2 ?? '-'
    });
  }
  return arr;
}

async function fetchMatch(id) {
  try {
    const res = await fetch('/api/match/' + encodeURIComponent(id));
    if (!res.ok) return;
    const data = await res.json();

    statusEl.textContent = "Match " + id;
    matchLabelEl.textContent = id;

    const setsArr = parseSetsArray(data);
    const games = data.games || {};
    const points = data.points || {};

    // names
    const p = data.players || [];
    const t1n1 = p[0]?.name || 'Team 1 - P1';
    const t1n2 = p[1]?.name || 'Team 1 - P2';
    const t2n1 = p[2]?.name || 'Team 2 - P1';
    const t2n2 = p[3]?.name || 'Team 2 - P2';

    team1NameEl.textContent = `${t1n1}/${t1n2}`.toUpperCase();
    team2NameEl.textContent = `${t2n1}/${t2n2}`.toUpperCase();

    if (!isEditingNames && p.length === 4 && namesForm.style.display !== 'none') {
      t1p1Input.value = t1n1;
      t1p2Input.value = t1n2;
      t2p1Input.value = t2n1;
      t2p2Input.value = t2n2;
    }

    // update set columns (max 3)
    for (let i = 0; i < setCells.length; i++) {
      const col = setCells[i];
      const s = setsArr[i];
      if (s) {
        col.t1.textContent = s.team1;
        col.t2.textContent = s.team2;
      } else {
        col.t1.textContent = '-';
        col.t2.textContent = '-';
      }
    }

    // points
    team1PointsEl.textContent = points.team1 ?? "0";
    team2PointsEl.textContent = points.team2 ?? "0";

    // server: data.server is team 1 or 2 from backend
    team1ServerDot.style.display = data.server === 1 ? 'inline-block' : 'none';
    team2ServerDot.style.display = data.server === 2 ? 'inline-block' : 'none';

    // summary text
    const setsSummary =
      data.setsString ||
      (setsArr.length ? setsArr.map(s => `${s.team1}-${s.team2}`).join(' / ') : '-');
    const g1 = games.team1 ?? "-";
    const g2 = games.team2 ?? "-";
    const p1 = points.team1 ?? "-";
    const p2 = points.team2 ?? "-";
    scoreSummaryEl.textContent = `S ${setsSummary}  G ${g1}-${g2}  P ${p1}-${p2}`;

    updatedAtEl.textContent = data.updatedAt
      ? new Date(data.updatedAt).toLocaleTimeString()
      : "";

    statsEl.textContent = JSON.stringify(
      { games, playerStats: data.playerStats || [] },
      null,
      2
    );

    updateImpactChart(data.timeline || []);
  } catch (err) {
    console.error(err);
  }
}

async function fetchList() {
  try {
    const res = await fetch('/api/matches');
    if (!res.ok) return;
    const list = await res.json();

    matchesList.innerHTML = "";
    if (!list.length) {
      matchesListEmpty.style.display = 'block';
      return;
    }

    matchesListEmpty.style.display = 'none';
    list.forEach(m => {
      const div = document.createElement('div');
      div.className = 'match-card';
      div.innerHTML = `
        <a href="?matchId=${m.matchId}">${m.matchId}</a>
        <small>${m.score}</small>
      `;
      matchesList.appendChild(div);
    });
  } catch {}
}

namesForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentMatchId) return;

  const body = {
    team1: { p1: t1p1Input.value, p2: t1p2Input.value },
    team2: { p1: t2p1Input.value, p2: t2p2Input.value }
  };

  await fetch(`/api/match/${encodeURIComponent(currentMatchId)}/players`, {
    method: 'POST',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  namesForm.style.display = 'none';
  isEditingNames = false;
});

namesForm.addEventListener('focusin', () => { isEditingNames = true; });
namesForm.addEventListener('focusout', () => {
  setTimeout(() => {
    if (!namesForm.contains(document.activeElement)) {
      isEditingNames = false;
    }
  }, 50);
});

function updateImpactChart(timeline) {
  const canvas = document.getElementById('impactChart');
  if (!canvas) return;

  if (!timeline.length) {
    if (impactChart) {
      impactChart.destroy();
      impactChart = null;
    }
    return;
  }

  const ctx = canvas.getContext('2d');

  const labels = timeline.map((_, i) => i + 1);
  const playerCount = Math.max(...timeline.map(s => (s.diff || []).length));
  const datasets = [];

  for (let i = 0; i < playerCount; i++) {
    datasets.push({
      label: `Player ${i + 1}`,
      data: timeline.map(s => (s.diff && s.diff[i] != null ? s.diff[i] : 0)),
      borderWidth: 2,
      tension: 0.3,
      fill: false
    });
  }

  if (impactChart) {
    impactChart.data.labels = labels;
    impactChart.data.datasets = datasets;
    impactChart.update();
  } else {
    impactChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            suggestedMin: -5,
            suggestedMax: 5,
            ticks: { color: '#f5f5f5' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          x: {
            ticks: { color: '#f5f5f5' },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#f5f5f5' }
          }
        }
      }
    });
  }
}

if (currentMatchId) {
  showMatch();
  startPolling(currentMatchId);
} else {
  showList();
  fetchList();
  setInterval(fetchList, 5000);
}
</script>

</body>
</html>
