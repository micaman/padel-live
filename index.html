<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Padel Live Scores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #111217;
      --card-bg: #f5f5f5;
      --card-border: #d4d4d4;
      --team-text: #111217;
      --set-bg: #111217;
      --set-text: #ffffff;
      --point-top-bg: #f7c948;
      --point-bottom-bg: #cfcfcf;
      --point-text: #111217;
      --divider: #d9d9d9;
      --server-dot: #57d657;
    }

    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top left, #303144, #111217 60%);
      font-family: system-ui, -apple-system, sans-serif;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* LIST VIEW */
    #listView {
      width: 100%;
      max-width: 520px;
    }

    .match-card {
      background: #181a25;
      border: 1px solid #26293a;
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .match-card a {
      color: #f5f5f5;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .match-card small {
      opacity: 0.8;
      font-size: 12px;
    }

    /* MATCH VIEW */
    #matchView {
      width: 100%;
      max-width: 520px;
      display: none;
    }

    .scoreboard-wrapper {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    .scoreboard {
      width: 100%;
      max-width: 480px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      display: grid;
      grid-template-columns: 44px 1fr 64px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
    }

    .sb-icon {
      background: linear-gradient(135deg, #242631, #151622);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-icon-symbol {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid #f7c948;
      position: relative;
    }

    .sb-teams {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .sb-row {
      padding: 6px 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
    }

    .sb-row + .sb-row {
      border-top: 1px solid var(--divider);
    }

    .team-name {
      color: var(--team-text);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .team-meta {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .set-score-badge {
      padding: 2px 6px;
      border-radius: 2px;
      background: var(--set-bg);
      color: var(--set-text);
      font-size: 11px;
      font-weight: 700;
    }

    .server-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--server-dot);
    }

    .sb-points {
      display: grid;
      grid-template-rows: 1fr 1fr;
      border-left: 1px solid var(--card-border);
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    .sb-point-top {
      background: var(--point-top-bg);
      color: var(--point-text);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sb-point-bottom {
      background: var(--point-bottom-bg);
      color: var(--point-text);
      border-top: 1px solid var(--card-border);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* PANELS */
    .panel {
      background: #181a25;
      border: 1px solid #26293a;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
    }

    .panel h3 {
      margin: 0 0 8px;
      font-size: 13px;
      text-transform: uppercase;
      opacity: .85;
    }

    .names-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .names-grid label {
      font-size: 11px;
      opacity: .7;
    }

    .names-grid input {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #3b3f52;
      background: #111217;
      color: #fff;
    }

    .panel button {
      margin-top: 8px;
      padding: 6px 10px;
      border: 1px solid #f7c948;
      background: #2b3042;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }

    /* CHART FIX */
    .chart-container {
      width: 100%;
      height: 200px;
      max-height: 200px;
      position: relative;
      overflow: hidden;
    }

    .debug {
      margin-top: 10px;
      padding: 10px;
      background: #111217;
      border-radius: 6px;
      border: 1px solid #25293a;
      font-size: 11px;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
    }

  </style>
</head>

<body>
  <h1>Padel Live</h1>

  <!-- HOME LIST -->
  <div id="listView">
    <p style="opacity:.85;">Select a match to view.</p>
    <div id="matchesList"></div>
    <div id="matchesListEmpty" style="display:none; opacity:.7;">No matches yet.</div>
  </div>

  <!-- MATCH PAGE -->
  <div id="matchView">
    <div id="status" class="status"></div>

    <div class="scoreboard-wrapper">
      <div class="scoreboard">
        <div class="sb-icon"><div class="sb-icon-symbol"></div></div>

        <div class="sb-teams">
          <div class="sb-row">
            <div class="team-name" id="team1Name">TEAM 1</div>
            <div class="team-meta">
              <span class="server-dot" id="team1ServerDot" style="display:none;"></span>
              <span class="set-score-badge" id="team1Sets">-</span>
            </div>
          </div>
          <div class="sb-row">
            <div class="team-name" id="team2Name">TEAM 2</div>
            <div class="team-meta">
              <span class="server-dot" id="team2ServerDot" style="display:none;"></span>
              <span class="set-score-badge" id="team2Sets">-</span>
            </div>
          </div>
        </div>

        <div class="sb-points">
          <div class="sb-point-top" id="team1Points">0</div>
          <div class="sb-point-bottom" id="team2Points">0</div>
        </div>
      </div>
    </div>

    <!-- PLAYER NAME FORM -->
    <div class="panel">
      <h3>Player Names</h3>
      <form id="namesForm">
        <div class="names-grid">
          <div>
            <label>Team 1 - Player 1</label>
            <input id="t1p1">
          </div>
          <div>
            <label>Team 1 - Player 2</label>
            <input id="t1p2">
          </div>
          <div>
            <label>Team 2 - Player 1</label>
            <input id="t2p1">
          </div>
          <div>
            <label>Team 2 - Player 2</label>
            <input id="t2p2">
          </div>
        </div>
        <button type="submit">Save Names</button>
      </form>

      <div class="debug">
        <strong>Match:</strong> <span id="matchLabel"></span><br>
        <strong>Summary:</strong> <span id="scoreSummary"></span><br>
        <strong>Last update:</strong> <span id="updatedAt"></span><br><br>
        <strong>Stats:</strong>
        <pre id="stats"></pre>
      </div>
    </div>

    <!-- CHART -->
    <div class="panel">
      <h3>Player Impact (Winners âˆ’ Errors)</h3>
      <div class="chart-container">
        <canvas id="impactChart"></canvas>
      </div>
    </div>
  </div>

<script>
let impactChart = null;
let isEditingNames = false;
let timer = null;

const params = new URLSearchParams(window.location.search);
let currentMatchId = params.get('matchId') || null;

const listView = document.getElementById('listView');
const matchView = document.getElementById('matchView');
const matchesList = document.getElementById('matchesList');
const matchesListEmpty = document.getElementById('matchesListEmpty');

const statusEl = document.getElementById('status');
const team1NameEl = document.getElementById('team1Name');
const team2NameEl = document.getElementById('team2Name');
const team1SetsEl = document.getElementById('team1Sets');
const team2SetsEl = document.getElementById('team2Sets');
const team1PointsEl = document.getElementById('team1Points');
const team2PointsEl = document.getElementById('team2Points');
const team1ServerDot = document.getElementById('team1ServerDot');
const team2ServerDot = document.getElementById('team2ServerDot');

const namesForm = document.getElementById('namesForm');
const t1p1Input = document.getElementById('t1p1');
const t1p2Input = document.getElementById('t1p2');
const t2p1Input = document.getElementById('t2p1');
const t2p2Input = document.getElementById('t2p2');

const matchLabelEl = document.getElementById('matchLabel');
const scoreSummaryEl = document.getElementById('scoreSummary');
const updatedAtEl = document.getElementById('updatedAt');
const statsEl = document.getElementById('stats');

function showList() {
  listView.style.display = 'block';
  matchView.style.display = 'none';
}
function showMatch() {
  listView.style.display = 'none';
  matchView.style.display = 'block';
}

function stopPolling() {
  if (timer) clearInterval(timer);
  timer = null;
}

function startPolling(id) {
  stopPolling();
  async function poll() {
    if (!isEditingNames) fetchMatch(id);
  }
  poll();
  timer = setInterval(poll, 2000);
}

async function fetchMatch(id) {
  try {
    const res = await fetch('/api/match/' + encodeURIComponent(id));
    if (!res.ok) return;

    const data = await res.json();

    // scoreboard
    matchLabelEl.textContent = id;
    statusEl.textContent = "Match " + id;

    const players = data.players || [];

    team1NameEl.textContent = (players[0]?.name + "/" + players[1]?.name).toUpperCase();
    team2NameEl.textContent = (players[2]?.name + "/" + players[3]?.name).toUpperCase();

    if (!isEditingNames && players.length === 4) {
      t1p1Input.value = players[0].name;
      t1p2Input.value = players[1].name;
      t2p1Input.value = players[2].name;
      t2p2Input.value = players[3].name;
    }

    team1SetsEl.textContent = data.sets?.team1 ?? "-";
    team2SetsEl.textContent = data.sets?.team2 ?? "-";
    team1PointsEl.textContent = data.points?.team1 ?? "0";
    team2PointsEl.textContent = data.points?.team2 ?? "0";

    team1ServerDot.style.display = data.server === 1 ? 'inline-block' : 'none';
    team2ServerDot.style.display = data.server === 2 ? 'inline-block' : 'none';

    scoreSummaryEl.textContent = `S ${data.sets.team1}-${data.sets.team2}  G ${data.games.team1}-${data.games.team2}  P ${data.points.team1}-${data.points.team2}`;

    updatedAtEl.textContent = data.updatedAt ? new Date(data.updatedAt).toLocaleTimeString() : "";

    statsEl.textContent = JSON.stringify({
      games: data.games,
      playerStats: data.playerStats
    }, null, 2);

    updateImpactChart(data.timeline || []);

  } catch (err) {
    console.error(err);
  }
}

async function fetchList() {
  try {
    const res = await fetch('/api/matches');
    if (!res.ok) return;
    const list = await res.json();

    matchesList.innerHTML = "";
    if (!list.length) {
      matchesListEmpty.style.display = 'block';
      return;
    }

    matchesListEmpty.style.display = 'none';
    list.forEach(m => {
      const div = document.createElement('div');
      div.className = 'match-card';
      div.innerHTML = `
        <a href="?matchId=${m.matchId}">${m.matchId}</a>
        <small>${m.score}</small>
      `;
      matchesList.appendChild(div);
    });
  } catch {}
}

namesForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const body = {
    team1: { p1: t1p1Input.value, p2: t1p2Input.value },
    team2: { p1: t2p1Input.value, p2: t2p2Input.value }
  };

  await fetch(`/api/match/${encodeURIComponent(currentMatchId)}/players`, {
    method: 'POST',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  namesForm.style.display = 'none';
  isEditingNames = false;
});

namesForm.addEventListener('focusin', () => isEditingNames = true);
namesForm.addEventListener('focusout', () => {
  setTimeout(() => {
    if (!namesForm.contains(document.activeElement)) isEditingNames = false;
  }, 50);
});

function updateImpactChart(timeline) {
  const ctx = document.getElementById('impactChart').getContext('2d');
  if (!timeline.length) {
    if (impactChart) impactChart.destroy();
    impactChart = null;
    return;
  }

  const labels = timeline.map((_, i) => i + 1);
  const playerCount = Math.max(...timeline.map(s => s.diff.length));

  const datasets = [];
  for (let i = 0; i < playerCount; i++) {
    datasets.push({
      label: `Player ${i + 1}`,
      data: timeline.map(s => s.diff[i]),
      borderWidth: 2,
      tension: 0.3,
      fill: false
    });
  }

  if (impactChart) {
    impactChart.data.labels = labels;
    impactChart.data.datasets = datasets;
    impactChart.update();
  } else {
    impactChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            suggestedMin: -5,
            suggestedMax: 5,
            ticks: { color: '#fff' }
          },
          x: {
            ticks: { color: '#fff' }
          }
        }
      }
    });
  }
}

if (currentMatchId) {
  showMatch();
  startPolling(currentMatchId);
} else {
  showList();
  fetchList();
  setInterval(fetchList, 5000);
}
</script>

</body>
</html>
